package hgtest.storage.bje.DefaultIndexImpl;


import org.easymock.EasyMock;
import org.hypergraphdb.HGException;
import org.hypergraphdb.storage.bje.*;
import org.powermock.api.easymock.PowerMock;
import org.junit.Test;

import static hgtest.storage.bje.TestUtils.assertExceptions;
import static org.easymock.EasyMock.replay;


/**
 * @author Yuriy Sechko
 */
public class DefaultIndexImpl_openTest extends DefaultIndexImplTestBasis
{
	@Test
	public void indexNameIsNull() throws Exception
	{
		mockStorage();
        replay(mockedStorage);

		final DefaultIndexImpl indexImpl = new DefaultIndexImpl(null, mockedStorage,
				transactionManager, keyConverter, valueConverter, comparator, null);

		// no exception here
		// just because (DB_NAME_PREFIX + name) becomes "hgstore_idx_null";
		indexImpl.open();

		closeDatabase(indexImpl);
	}

	@Test
	public void transactionManagerIsNull() throws Exception
	{
		startupEnvironment();
        replay(mockedStorage);

		final DefaultIndexImpl indexImpl = new DefaultIndexImpl(INDEX_NAME,
                mockedStorage, null, keyConverter, valueConverter, comparator, null);

		// no exception here
		closeDatabase(indexImpl);

		closeDatabase(indexImpl);
	}

	@Test
	public void keyConverterIsNull() throws Exception
	{
		startupEnvironment();
		mockStorage();
        replay(mockedStorage);

		final DefaultIndexImpl indexImpl = new DefaultIndexImpl(INDEX_NAME,
                mockedStorage, transactionManager, null, valueConverter, comparator, null);

		// no exception here
		indexImpl.open();

		closeDatabase(indexImpl);
	}

	@Test
	public void valueConverterIsNull() throws Exception
	{
		startupEnvironment();
		mockStorage();
        replay(mockedStorage);

		final DefaultIndexImpl indexImpl = new DefaultIndexImpl(INDEX_NAME,
                mockedStorage, transactionManager, keyConverter, null, comparator, null);

		// no exception here
		indexImpl.open();

		closeDatabase(indexImpl);
	}

	@Test
	public void storageThrowsException() throws Exception
	{
		final Exception expected = new HGException(
				"While attempting to open index ;sample_index': java.lang.IllegalStateException: This exception is thrown by fake storage.");

		startupEnvironment();
		EasyMock.expect(mockedStorage.getConfiguration()).andReturn(new BJEConfig());
		EasyMock.expect(mockedStorage.getBerkleyEnvironment()).andThrow(
				new IllegalStateException(
						"This exception is thrown by fake storage."));
        replay(mockedStorage);

		final DefaultIndexImpl indexImpl = new DefaultIndexImpl(INDEX_NAME,
                mockedStorage, transactionManager, keyConverter, valueConverter,
				comparator, null);

		try
		{
			indexImpl.open();
		}
		catch (Exception occurred)
		{
			assertExceptions(occurred, expected);
		}
	}
}
